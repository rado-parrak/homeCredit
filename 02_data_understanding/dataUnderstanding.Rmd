---
title: Data Understanding
author: Rado
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
---

```{r echo=FALSE, warning = FALSE, message = FALSE}
# Clean workspace and load libs:
rm(list = ls())

library(dplyr)
library(kableExtra)
library(ggplot2)
library(gridExtra)
```

# Summary of things noticed in the data
```{r echo=FALSE, warning = FALSE, message = FALSE}
issues <- c( 'A lot of columns with missing values - to be tackled in data preparation!'
            , 'Very different proportions of Cash Loans vs. Revolving Loans in data. Different loans in nature - Best to create single model per loan type ??? - to be tackled in modelling'
            , 'AMT_INCOME_TOTAL contains several very frequent values...?? - binning should take care of this in data processing'
            ,"Only documents 3,5, 6 and 8 submitted in some significant numbers."
            , 'In the NAME_TYPE_SUITE there is "" level -> to be corrected in the data preparation'
            , 'the "AMT_" variables contain outliers. To be considered in the data preparation & feature generation'
            , 'AMT_TOTAL_INCOME has a couple of dominant income levels - to be taken up in the data preparation'
            , 'Create AGE from DAYS_BIRTH'
            , 'CNT_CHILDREN contains rare levels -> data preparation'
            , 'CNT_FAM_MEMBERS contains rare levels -> data preparation')

dataSet <- c('application data'
             , 'application data'
             , 'application data'
             , 'application data'
             , 'application data'
             , 'application data'
             , 'application data'
             , 'application data'
             , 'application data'
             , 'application data')

knitr::kable(data.frame(nr. = seq(1,length(issues)),dataSet = dataSet, issues = issues)) %>%
  kable_styling(font_size = 10, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, width = "1cm", border_right = T) %>%
  column_spec(2, width = "7cm")
```

# Data Model
![](../01_raw_data/data_model.png)

# Column descriptions
```{r echo=FALSE, warning = FALSE, message = FALSE}
knitr::kable(read.csv('../01_raw_data/HomeCredit_columns_description.csv', header = T)[,2:5]) %>%
  kable_styling(font_size = 10, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  column_spec(1, width = "2cm", border_right = T) %>%
  column_spec(2, width = "2cm") %>%
  column_spec(3, width = "5cm") %>%
  column_spec(4, width = "5cm")
```

# Individual Data Inputs

## application_train.csv | application_test.csv

```{r echo=FALSE, warning = FALSE, message = FALSE}
checkedColumns <- 0
namessContainer <- c("SK_ID_CURR")

appDataTrain  <- read.csv('../01_raw_data/application_train.csv', header = T) %>% mutate(dataPartition = 'train')
appDataTest   <- read.csv('../01_raw_data/application_test.csv', header = T) %>% 
  mutate(TARGET = NA) %>%
  mutate(dataPartition = 'test') %>%
  dplyr::select(colnames(appDataTrain))
  
appData <- rbind(appDataTrain, appDataTest)
rm(appDataTrain, appDataTest)
```

```{r echo=TRUE, warning = FALSE, message = FALSE}
# Scan variables
str(appData, list.len=ncol(appData))

# Uniqueness of the key
length(appData$SK_ID_CURR) == length(unique(appData$SK_ID_CURR))
```

### NA percetage per attribute

```{r echo=FALSE, warning = FALSE, message = FALSE}
NAsummary <- as.data.frame(sapply(dplyr::filter(appData, dataPartition == 'train'), function(x) sum(is.na(x)))) 
colnames(NAsummary) <- c('cNA')

NAsummary <- mutate(NAsummary, attribute = row.names(NAsummary)) %>%
  mutate(cRows = nrow(dplyr::filter(appData, dataPartition == 'train'))) %>%
  mutate(NApercentage = cNA/cRows) %>%
  filter(NApercentage > 0.05)

p1 <- ggplot(data=NAsummary, aes(x=reorder(attribute,-NApercentage), y=NApercentage))+
      geom_bar(stat='identity') +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ggtitle("NA percentage | train")

NAsummary <- as.data.frame(sapply(dplyr::filter(appData,dataPartition == 'test'), function(x) sum(is.na(x)))) 
colnames(NAsummary) <- c('cNA')

NAsummary <- mutate(NAsummary, attribute = row.names(NAsummary)) %>%
  mutate(cRows = nrow(dplyr::filter(appData, dataPartition == 'test'))) %>%
  mutate(NApercentage = cNA/cRows) %>%
  filter(NApercentage > 0.05)

p2 <- ggplot(data=NAsummary, aes(x=reorder(attribute,-NApercentage), y=NApercentage))+
      geom_bar(stat='identity') +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ggtitle("NA percentage | test")

print(p1)
print(p2)
```

### TARGET EVENT RATE (in train)

```{r echo=FALSE, warning = FALSE, message = FALSE}
ggplot(data = appData[!is.na(appData$TARGET),], aes(x = TARGET)) + 
          geom_bar(aes(y = (..count..)/sum(..count..))) + 
          scale_y_continuous(labels=scales::percent) +
  ylab("relative frequencies")

namessContainer <- c(namessContainer, "TARGET")
checkedColumns <- checkedColumns + 1
```

### FLAGS

```{r echo=FALSE, warning = FALSE, message = FALSE}
## non-document related
namess          <- c('SK_ID_CURR','dataPartition',colnames(appData)[grepl('FLAG', colnames(appData))])
namessContainer <- c(namessContainer, namess)
dataForPlot   <- appData[,namess[1:10]] %>% reshape2::melt(id.vars = c('SK_ID_CURR','dataPartition'))
dataForPlot$value[dataForPlot$value == "Y"] <- '1'
dataForPlot$value[dataForPlot$value == "N"] <- '0'
dataForPlot$value[dataForPlot$value == 1]   <- '1'
dataForPlot$value[dataForPlot$value == 0]   <- '0'
dataForPlot$value[is.na(dataForPlot$value)] <- 'Unknown'
dataForPlot$value <- as.factor(dataForPlot$value)

dataForPlot <- dplyr::group_by(dataForPlot, dataPartition, variable, value) %>% 
  dplyr::summarize(countt = length(SK_ID_CURR)) %>%
  dplyr::ungroup() %>% 
  dplyr::left_join(y = (dplyr::group_by(dataForPlot,dataPartition, variable) %>% 
                          dplyr::summarize(count_agg = length(SK_ID_CURR)) %>%
                          dplyr::ungroup())
                   , by = c('dataPartition', 'variable')) %>%
  dplyr::mutate(percentage = countt / count_agg)
  
ggplot(data = dataForPlot, aes(x = variable, y = percentage)) +
  geom_bar(stat = "identity", aes(fill = value)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + facet_grid(. ~ dataPartition)

knitr::kable(reshape2::dcast(dataForPlot, variable~dataPartition+value, value.var = "percentage")) %>% kable_styling(font_size = 10)
knitr::kable(reshape2::dcast(dataForPlot, variable~dataPartition+value, value.var = "countt")) %>% kable_styling(font_size = 10)

## document related
dataForPlot   <- appData[,namess[c(1,2,11:29)]] %>% reshape2::melt(id.vars = c('SK_ID_CURR','dataPartition'))
dataForPlot$value[dataForPlot$value == "Y"] <- '1'
dataForPlot$value[dataForPlot$value == "N"] <- '0'
dataForPlot$value[dataForPlot$value == 1]   <- '1'
dataForPlot$value[dataForPlot$value == 0]   <- '0'
dataForPlot$value[is.na(dataForPlot$value)] <- 'Unknown'
dataForPlot$value <- as.factor(dataForPlot$value)

dataForPlot <- dplyr::group_by(dataForPlot, dataPartition, variable, value) %>% 
  dplyr::summarize(countt = length(SK_ID_CURR)) %>%
  dplyr::ungroup() %>% 
  dplyr::left_join(y = (dplyr::group_by(dataForPlot,dataPartition, variable) %>% 
                          dplyr::summarize(count_agg = length(SK_ID_CURR)) %>%
                          dplyr::ungroup())
                   , by = c('dataPartition', 'variable')) %>%
  dplyr::mutate(percentage = countt / count_agg)
  
ggplot(data = dataForPlot, aes(x = variable, y = percentage)) +
  geom_bar(stat = "identity", aes(fill = value)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + facet_grid(. ~ dataPartition)

knitr::kable(reshape2::dcast(dataForPlot, variable~dataPartition+value, value.var = "percentage")) %>% kable_styling(font_size = 10)
knitr::kable(reshape2::dcast(dataForPlot, variable~dataPartition+value, value.var = "countt")) %>% kable_styling(font_size = 10)

checkedColumns <- checkedColumns + length(namess) - 2
```

### NAMES
```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('dataPartition', colnames(appData)[grepl("NAME_", colnames(appData))])
namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData[,namess] %>% reshape2::melt(id.vars = 'dataPartition')
dataForPlot$value[dataForPlot$value == ""] <- "Unknown"
dataForPlot$value <- as.factor(dataForPlot$value)

for(varToPlot in namess[2:length(namess)]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(dataPartition,value) %>% 
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::left_join(y = (dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::group_by(dataPartition) %>% 
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())
                     , by = c('dataPartition')) %>%
    dplyr::mutate(percentage = countt / count_agg)
  
  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))  +
        facet_grid(.~dataPartition) +
        ggtitle(varToPlot)
  
  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

### Amounts
```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('dataPartition', colnames(appData)[grepl("AMT_", colnames(appData))])
namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData

for(varToPlot in namess[2:5]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

dataForPlot     <- appData[,namess[c(1,6:11)]] %>% reshape2::melt(id.vars = 'dataPartition')

for(varToPlot in namess[6:11]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(dataPartition,value) %>%
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::left_join(y = (dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::group_by(dataPartition) %>%
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())
                     , by = c('dataPartition')) %>%
    dplyr::mutate(percentage = countt / count_agg)

  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 0, hjust = 1))  +
        facet_grid(.~dataPartition) +
        ggtitle(varToPlot)

  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

### Living related

#### Averages
```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('dataPartition', colnames(appData)[grepl("_AVG", colnames(appData))])
namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData[,namess]

for(varToPlot in namess[2:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

#### Modes
```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('dataPartition', colnames(appData)[grepl("_MODE", colnames(appData))])[1:15]
namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData[,namess]

for(varToPlot in namess[2:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

#### Medians
```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('dataPartition', colnames(appData)[grepl("_MEDI", colnames(appData))])
namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData[,namess]

for(varToPlot in namess[2:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

### External sources

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('dataPartition', colnames(appData)[grepl("EXT_", colnames(appData))])
namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData[,namess]

for(varToPlot in namess[2:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

### Other

```{r echo=FALSE, warning = FALSE, message = FALSE}
# interval:
namess          <- c('dataPartition'
                     , 'REGION_POPULATION_RELATIVE'
                     , 'DAYS_BIRTH'
                     , 'DAYS_BIRTH'
                     , 'DAYS_REGISTRATION'
                     , 'DAYS_EMPLOYED'
                     , 'DAYS_ID_PUBLISH'
                     , 'OWN_CAR_AGE'
                     , 'DAYS_LAST_PHONE_CHANGE'
                     , 'TOTALAREA_MODE'
                     , 'OBS_30_CNT_SOCIAL_CIRCLE'
                     , 'DEF_30_CNT_SOCIAL_CIRCLE'
                     , 'OBS_60_CNT_SOCIAL_CIRCLE'
                     , 'DEF_60_CNT_SOCIAL_CIRCLE')
namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData[,namess]

for(varToPlot in namess[2:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density.., fill = dataPartition), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess) - 1

# factor:
namess          <- c('dataPartition'
                     , 'CODE_GENDER'
                     , 'CNT_CHILDREN'
                     , 'OCCUPATION_TYPE'
                     , 'CNT_FAM_MEMBERS'
                     , 'REGION_RATING_CLIENT'
                     , 'REGION_RATING_CLIENT_W_CITY'
                     , 'WEEKDAY_APPR_PROCESS_START'
                     , 'REG_REGION_NOT_LIVE_REGION'
                     , 'REG_REGION_NOT_WORK_REGION'
                     , 'LIVE_REGION_NOT_WORK_REGION'
                     , 'REG_CITY_NOT_LIVE_CITY'
                     , 'REG_CITY_NOT_WORK_CITY'
                     , 'LIVE_CITY_NOT_WORK_CITY'
                     , 'ORGANIZATION_TYPE'
                     , 'HOUR_APPR_PROCESS_START'
                     , 'FONDKAPREMONT_MODE'
                     , 'HOUSETYPE_MODE'
                     , 'WALLSMATERIAL_MODE'
                     , 'EMERGENCYSTATE_MODE')

namessContainer <- c(namessContainer, namess)
dataForPlot     <- appData[,namess] %>% reshape2::melt(id.vars = 'dataPartition')
dataForPlot$value[dataForPlot$value == ""] <- "Unknown"
dataForPlot$value <- as.factor(dataForPlot$value)

for(varToPlot in namess[2:length(namess)]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(dataPartition,value) %>% 
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::left_join(y = (dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::group_by(dataPartition) %>% 
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())
                     , by = c('dataPartition')) %>%
    dplyr::mutate(percentage = countt / count_agg)
  
  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))  +
        facet_grid(.~dataPartition) +
        ggtitle(varToPlot)
  
  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

### Check if all columns has been explored
```{r echo=FALSE, warning = FALSE, message = FALSE, results='markup'}
print(paste0('Columns to be checked : ',ncol(appData)))
print(paste0('Checked columns : ', checkedColumns + 2))
print(paste0('Remaining columns to be checked: ', paste0(colnames(appData)[!(colnames(appData) %in% unique(namessContainer))], collapse = ', ')))
```

## bureau.csv

```{r echo=FALSE, warning = FALSE, message = FALSE}
rm(appData)
checkedColumns <- 0
namessContainer <- c("SK_ID_CURR", 'SK_ID_BUREAU')
bureauData  <- read.csv('../01_raw_data/bureau.csv', header = T)
```

```{r echo=TRUE, warning = FALSE, message = FALSE}
# Scan variables
str(bureauData, list.len=ncol(bureauData))

# Uniqueness of the key
length(bureauData$SK_ID_BUREAU) == length(unique(bureauData$SK_ID_BUREAU))
```

### NA percetage per attribute

```{r echo=FALSE, warning = FALSE, message = FALSE}
NAsummary <- as.data.frame(sapply(bureauData, function(x) sum(is.na(x)))) 
colnames(NAsummary) <- c('cNA')

NAsummary <- mutate(NAsummary, attribute = row.names(NAsummary)) %>%
  mutate(cRows = nrow(bureauData)) %>%
  mutate(NApercentage = cNA/cRows)

p1 <- ggplot(data=NAsummary, aes(x=reorder(attribute,-NApercentage), y=NApercentage))+
      geom_bar(stat='identity') +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ggtitle("NA percentage")

print(p1)
```

### Intervals

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('SK_ID_BUREAU'
                     , 'DAYS_CREDIT'
                     , 'CREDIT_DAY_OVERDUE'
                     , 'DAYS_CREDIT_ENDDATE'
                     , 'DAYS_ENDDATE_FACT'
                     , 'AMT_CREDIT_MAX_OVERDUE'
                     , 'CNT_CREDIT_PROLONG'
                     , 'AMT_CREDIT_SUM'
                     , 'AMT_CREDIT_SUM_DEBT'
                     , 'AMT_CREDIT_SUM_LIMIT'
                     , 'AMT_CREDIT_SUM_OVERDUE'
                     , 'DAYS_CREDIT_UPDATE'
                     , 'AMT_ANNUITY')

namessContainer <- c(namessContainer, namess)
dataForPlot     <- bureauData[,namess]

for(varToPlot in namess[2:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density..), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density..), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

### Factors

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('SK_ID_BUREAU'
                     ,'CREDIT_ACTIVE'
                     , 'CREDIT_CURRENCY'
                     , 'CREDIT_TYPE')

namessContainer <- c(namessContainer, namess)
dataForPlot     <- bureauData[,namess] %>% reshape2::melt(id.vars = 'SK_ID_BUREAU')
dataForPlot$value[dataForPlot$value == ""] <- "Unknown"
dataForPlot$value <- as.factor(dataForPlot$value)

for(varToPlot in namess[2:length(namess)]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(value) %>% 
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(count_agg = as.numeric(dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())) %>%
    dplyr::mutate(percentage = countt / count_agg)
  
  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        ggtitle(varToPlot)
  
  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 1
```

### Check if all columns has been explored
```{r echo=FALSE, warning = FALSE, message = FALSE, results='markup'}
print(paste0('Columns to be checked : ',ncol(bureauData)))
print(paste0('Checked columns : ', checkedColumns + 2))
print(paste0('Remaining columns to be checked: ', paste0(colnames(bureauData)[!(colnames(bureauData) %in% unique(namessContainer))], collapse = ', ')))
```

## POS_CASH_balance.csv

```{r echo=FALSE, warning = FALSE, message = FALSE}
rm(appData)
checkedColumns <- 0
namessContainer <- c("SK_ID_CURR", 'SK_ID_BUREAU')
posData  <- read.csv('../01_raw_data/POS_CASH_balance.csv', header = T)
```

```{r echo=TRUE, warning = FALSE, message = FALSE}
# Scan variables
str(posData, list.len=ncol(posData))

# Uniqueness of the key
print('No unique key, combination of SK_ID_PREV and SK_ID_CURR is unique ==> Link table.')
```

### Intervals

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('MONTHS_BALANCE'
                     , 'CNT_INSTALMENT'
                     , 'CNT_INSTALMENT_FUTURE'
                     , 'SK_DPD'
                     , 'SK_DPD_DEF'
                     )

namessContainer <- c(namessContainer, namess)
dataForPlot     <- posData[,namess]

for(varToPlot in namess[1:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density..), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density..), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess)
```

### Factors

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('SK_ID_PREV','SK_ID_CURR','NAME_CONTRACT_STATUS')

namessContainer <- c(namessContainer, namess)
dataForPlot     <- posData[,namess] %>%  
  tidyr::unite('unique_ID','SK_ID_PREV', 'SK_ID_CURR', sep = "_") %>% 
  reshape2::melt(id.vars = 'unique_ID')
dataForPlot$value[dataForPlot$value == ""] <- "Unknown"
dataForPlot$value <- as.factor(dataForPlot$value)

for(varToPlot in namess[3:length(namess)]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(value) %>% 
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(count_agg = as.numeric(dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())) %>%
    dplyr::mutate(percentage = countt / count_agg)
  
  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        ggtitle(varToPlot)
  
  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 2
```

### Check if all columns has been explored
```{r echo=FALSE, warning = FALSE, message = FALSE, results='markup'}
print(paste0('Columns to be checked : ',ncol(posData)))
print(paste0('Checked columns : ', checkedColumns + 2))
print(paste0('Remaining columns to be checked: ', paste0(colnames(posData)[!(colnames(posData) %in% unique(namessContainer))], collapse = ', ')))
```

## previous_application.csv
```{r echo=FALSE, warning = FALSE, message = FALSE}
rm(appData)
checkedColumns <- 0
namessContainer <- c("SK_ID_CURR", 'SK_ID_BUREAU')
prevappData  <- read.csv('../01_raw_data/previous_application.csv', header = T)
```

```{r echo=TRUE, warning = FALSE, message = FALSE}
# Scan variables
str(prevappData, list.len=ncol(prevappData))

# Uniqueness of the key
print('No unique key, combination of SK_ID_PREV and SK_ID_CURR is unique ==> Link table.')
```

### NA percetage per attribute

```{r echo=FALSE, warning = FALSE, message = FALSE}
NAsummary <- as.data.frame(sapply(prevappData, function(x) sum(is.na(x)))) 
colnames(NAsummary) <- c('cNA')

NAsummary <- mutate(NAsummary, attribute = row.names(NAsummary)) %>%
  mutate(cRows = nrow(prevappData)) %>%
  mutate(NApercentage = cNA/cRows)

p1 <- ggplot(data=NAsummary, aes(x=reorder(attribute,-NApercentage), y=NApercentage))+
      geom_bar(stat='identity') +
      theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
      ggtitle("NA percentage")

print(p1)
```

### NAMES
```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('SK_ID_PREV','SK_ID_CURR',colnames(prevappData)[grepl("NAME_", colnames(prevappData))])
namessContainer <- c(namessContainer, namess)
dataForPlot     <- prevappData[,namess] %>%  
  tidyr::unite('unique_ID','SK_ID_PREV', 'SK_ID_CURR', sep = "_") %>% 
  reshape2::melt(id.vars = 'unique_ID')
dataForPlot$value[dataForPlot$value == ""] <- "Unknown"
dataForPlot$value <- as.factor(dataForPlot$value)

for(varToPlot in namess[3:length(namess)]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(value) %>% 
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(count_agg = as.numeric(dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())) %>%
    dplyr::mutate(percentage = countt / count_agg)
  
  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        ggtitle(varToPlot)
  
  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 2
```

### Intervals

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('AMT_ANNUITY'
                     , 'AMT_APPLICATION'
                     , 'AMT_CREDIT'
                     , 'AMT_DOWN_PAYMENT'
                     , 'AMT_GOODS_PRICE'
                     , 'RATE_DOWN_PAYMENT'
                     , 'RATE_INTEREST_PRIMARY'
                     , 'RATE_INTEREST_PRIVILEGED'
                     , 'DAYS_DECISION'
                     , 'SELLERPLACE_AREA'
                     , 'CNT_PAYMENT'
                     , 'DAYS_FIRST_DRAWING'
                     , 'DAYS_FIRST_DUE'
                     , 'DAYS_LAST_DUE_1ST_VERSION'
                     , 'DAYS_LAST_DUE'
                     , 'DAYS_TERMINATION')

namessContainer <- c(namessContainer, namess)
dataForPlot     <- prevappData[,namess]

for(varToPlot in namess[1:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density..), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density..), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess)
```

### Factors

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('SK_ID_PREV'
                     , 'SK_ID_CURR'
                     , 'WEEKDAY_APPR_PROCESS_START'
                     , 'HOUR_APPR_PROCESS_START'
                     , 'FLAG_LAST_APPL_PER_CONTRACT'
                     , 'NFLAG_LAST_APPL_IN_DAY'
                     , 'CODE_REJECT_REASON'
                     , 'CHANNEL_TYPE'
                     , 'PRODUCT_COMBINATION'
                     , 'NFLAG_INSURED_ON_APPROVAL')

namessContainer <- c(namessContainer, namess)
dataForPlot     <- prevappData[,namess] %>%  
  tidyr::unite('unique_ID','SK_ID_PREV', 'SK_ID_CURR', sep = "_") %>% 
  reshape2::melt(id.vars = 'unique_ID')
dataForPlot$value[dataForPlot$value == ""] <- "Unknown"
dataForPlot$value <- as.factor(dataForPlot$value)

for(varToPlot in namess[3:length(namess)]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(value) %>% 
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(count_agg = as.numeric(dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())) %>%
    dplyr::mutate(percentage = countt / count_agg)
  
  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        ggtitle(varToPlot)
  
  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 2
```

### Check if all columns has been explored
```{r echo=FALSE, warning = FALSE, message = FALSE, results='markup'}
print(paste0('Columns to be checked : ',ncol(prevappData)))
print(paste0('Checked columns : ', checkedColumns + 2))
print(paste0('Remaining columns to be checked: ', paste0(colnames(prevappData)[!(colnames(prevappData) %in% unique(namessContainer))], collapse = ', ')))
```

## credit_card_balance.csv
```{r echo=FALSE, warning = FALSE, message = FALSE}
rm(appData)
checkedColumns <- 0
namessContainer <- c("SK_ID_CURR", 'SK_ID_BUREAU')
ccbData  <- read.csv('../01_raw_data/credit_card_balance.csv', header = T)
```

```{r echo=TRUE, warning = FALSE, message = FALSE}
# Scan variables
str(ccbData, list.len=ncol(ccbData))

# Uniqueness of the key
print('No unique key, combination of SK_ID_PREV and SK_ID_CURR is unique ==> Link table.')
```

### Amounts

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c(colnames(ccbData)[grepl("AMT_", colnames(ccbData))])
namessContainer <- c(namessContainer, namess)
dataForPlot     <- ccbData

for(varToPlot in namess[1:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density..), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density..), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess)
```

### Intervals

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('MONTHS_BALANCE'
                     , 'CNT_DRAWINGS_ATM_CURRENT'
                     , 'CNT_DRAWINGS_CURRENT'
                     , 'CNT_DRAWINGS_OTHER_CURRENT'
                     , 'CNT_DRAWINGS_POS_CURRENT'
                     , 'CNT_INSTALMENT_MATURE_CUM'
                     , 'SK_DPD'
                     , 'SK_DPD_DEF'
                     )

namessContainer <- c(namessContainer, namess)
dataForPlot     <- ccbData[,namess]

for(varToPlot in namess[1:length(namess)]){
  p1 <- ggplot(data = dataForPlot) + 
        geom_histogram(breaks=seq(quantile(dataForPlot[,varToPlot],0.05, na.rm = TRUE), quantile(dataForPlot[,varToPlot],0.90, na.rm = TRUE), length.out	= 30), aes(x=dataForPlot[,varToPlot],y=..density..), position="identity", alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=7), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Scaled histogram | ', varToPlot))
  
  p2 <- ggplot(data = dataForPlot) +
        geom_density(aes(x=dataForPlot[,varToPlot],y=..density..), kernel = 'gaussian', alpha = 0.5) +
        scale_x_continuous(labels = scales::comma) +
        scale_y_continuous(labels = scales::comma) +
        xlab(varToPlot) +
        theme(legend.position="top", legend.text=element_text(size=9), plot.title = element_text(size = 9, face = "bold")) +
        ggtitle(paste0('Density plot | ', varToPlot))
  
  grid.arrange(p1,p2, ncol=2)
}

checkedColumns <- checkedColumns + length(namess)
```

### Factors

```{r echo=FALSE, warning = FALSE, message = FALSE}
namess          <- c('SK_ID_PREV','SK_ID_CURR','NAME_CONTRACT_STATUS')

namessContainer <- c(namessContainer, namess)
dataForPlot     <- ccbData[,namess] %>%  
  tidyr::unite('unique_ID','SK_ID_PREV', 'SK_ID_CURR', sep = "_") %>% 
  reshape2::melt(id.vars = 'unique_ID')
dataForPlot$value[dataForPlot$value == ""] <- "Unknown"
dataForPlot$value <- as.factor(dataForPlot$value)

for(varToPlot in namess[3:length(namess)]){
  dataForPlotSel <- dplyr::filter(dataForPlot, variable == varToPlot) %>%
    dplyr::group_by(value) %>% 
    dplyr::summarize(countt = length(value)) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(count_agg = as.numeric(dplyr::filter(dataForPlot, variable == varToPlot) %>%
                            dplyr::summarize(count_agg = length(value)) %>%
                            dplyr::ungroup())) %>%
    dplyr::mutate(percentage = countt / count_agg)
  
  p <- ggplot(data = dataForPlotSel, aes(x = value, y = percentage)) +
        geom_bar(stat = "identity", aes(fill = value)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        ggtitle(varToPlot)
  
  print(p)
}

checkedColumns <- checkedColumns + length(namess) - 2
```

### Check if all columns has been explored
```{r echo=FALSE, warning = FALSE, message = FALSE, results='markup'}
print(paste0('Columns to be checked : ',ncol(ccbData)))
print(paste0('Checked columns : ', checkedColumns + 2))
print(paste0('Remaining columns to be checked: ', paste0(colnames(ccbData)[!(colnames(ccbData) %in% unique(namessContainer))], collapse = ', ')))
```

